# Лабораторная работа 7 - Работа с сессиями в PHP

## Описание
Реализован PHP MVC проект простого магазина с поддержкой многопользовательского доступа через сессии.

## Структура проекта

```
lab7/
├── config/
│   └── db.php                 # Конфигурация базы данных
├── models/
│   ├── User.php              # Модель пользователя
│   ├── Auth.php              # Система аутентификации
│   ├── Product.php           # Модель товара
│   ├── Order.php             # Модель заказа
│   └── Customer.php          # Модель покупателя
├── controllers/
│   ├── Controller.php        # Базовый контроллер
│   ├── AuthController.php    # Контроллер аутентификации
│   ├── ProductController.php # Контроллер товаров
│   ├── OrderController.php   # Контроллер заказов
│   └── HomeController.php    # Контроллер главной страницы
├── views/
│   ├── header.php            # Шапка (навигация)
│   ├── footer.php            # Подвал
│   ├── auth/                 # Представления аутентификации
│   ├── products/             # Представления товаров
│   ├── orders/               # Представления заказов
│   └── home/                 # Представления главной страницы
├── public/
│   └── css/
│       └── style.css         # Стили
├── sql/
│   └── schema.sql            # Схема БД
├── index.php                 # Главный файл маршрутизации
├── .htaccess                 # Конфигурация Apache
└── README.md                 # Этот файл
```

## Установка и запуск

### 1. Создайте базу данных
- Откройте phpMyAdmin или MySQL CLI
- Запустите SQL команды из файла `sql/schema.sql`

```sql
-- Или просто скопируйте содержимое schema.sql и выполните
```

### 2. Настройка конфигурации
Отредактируйте `config/db.php` с вашими параметрами подключения:

```php
private $host = 'localhost';      // Хост БД
private $db_name = 'simple_shop'; // Имя БД
private $user = 'root';           // Пользователь
private $password = '';           // Пароль
```

### 3. Запуск проекта
- Разместите папку `lab7` в корне веб-сервера (htdocs для XAMPP)
- Откройте браузер: `http://localhost/lab7/index.php`

## Реализованные задания

### Задание 1: Кастомизация представления заказов
✓ Поле "Выберите пользователя" появляется только у администратора
✓ В списке заказов у зарегистрированного пользователя скрыты поля ID и Покупатель
✓ Администратор видит полную таблицу со всеми полями

**Файлы:**
- `views/orders/index.php` - таблица с условным отображением полей
- `views/orders/form.php` - форма с условным полем выбора пользователя

### Задание 2: Доступ незарегистрированного пользователя
✓ Незарегистрированный пользователь видит список всех товаров
✓ Нет возможности добавлять, редактировать и удалять товары
✓ Нет доступа к разделу заказов
✓ Видит кнопку для входа/регистрации

**Файлы:**
- `views/home/index.php` - главная страница с проверкой прав
- `views/products/index.php` - товары с условным отображением кнопок редактирования
- `controllers/ProductController.php` - контроль доступа

### Задание 3 (дополнительное): Редактирование профиля пользователя
✓ Зарегистрированный пользователь может редактировать свою запись в таблице customers
✓ Можно изменить имя, email и телефон

**Реализация:**
- Метод `updateCustomer()` в модели `User.php`
- Можно создать отдельный контроллер `ProfileController.php` для полной реализации

## Роли и права доступа

### Администратор (admin)
- Полные CRUD права для товаров
- Полные CRUD права для заказов (может видеть и редактировать заказы всех пользователей)
- Полный доступ к системе

### Зарегистрированный пользователь (user)
- Просмотр и редактирование только своих заказов
- Просмотр всех товаров
- Ограниченные права (не может создавать товары)

### Гость (не авторизован)
- Просмотр товаров только
- Отсутствие доступа к заказам
- Возможность входа/регистрации

## Данные для входа

```
Администратор:
- Логин: admin
- Пароль: 123456

Пользователь:
- Логин: user1
- Пароль: 123456
```

## Технологические решения

### Сессии PHP
- Использование `session_start()` в начале каждого запроса
- `session_regenerate_id(true)` при логине для защиты от перехвата
- `session_destroy()` при логауте

### Аутентификация
- Хеширование паролей с помощью `password_hash()` (BCRYPT)
- Проверка пароля через `password_verify()`
- Сохранение данных пользователя в `$_SESSION`

### Контроль доступа
- Проверка роли пользователя перед выполнением действий
- `Auth::requireLogin()` - проверка авторизации
- `Auth::requireAdmin()` - проверка прав администратора
- Фильтрация данных на уровне модели

### MVC архитектура
- Разделение логики (Models), представления (Views), управления (Controllers)
- Использование классов для организации кода
- Автоматическая маршрутизация через параметры GET

## Безопасность

- ✓ Защита от SQL-инъекций (использование prepared statements)
- ✓ Хеширование паролей (password_hash / password_verify)
- ✓ Регенерация session ID при логине
- ✓ Проверка прав на уровне контроллера и модели
- ✓ Использование htmlspecialchars() для защиты от XSS
- ✓ Проверка CSRF токена (может быть добавлена в форме)

## Возможные улучшения

1. Добавить CSRF токены в формы
2. Реализовать логирование действий
3. Добавить пагинацию для таблиц
4. Реализовать валидацию на клиенте
5. Добавить восстановление пароля
6. Реализовать кэширование
7. Добавить тестирование (PHPUnit)

## Используемые технологии

- PHP 7.0+
- MySQL / MariaDB
- HTML5
- CSS3
- jQuery (опционально)
- Apache (.htaccess)

## Автор

Лабораторная работа выполнена как учебное задание.
